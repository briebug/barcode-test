## Customize the test machine
machine:
    timezone:
        America/Denver # Set the timezone

    environment:
        XCODE_WORKSPACE: "platforms/ios/barcode-test.xcworkspace"
        GYM_CODE_SIGNING_IDENTITY: "iPhone Distribution: BrieBug Software, Inc. (4CS6W5LV48)"
        SIGNING_KEY_URI: "https://s3.amazonaws.com/briebug-build/barcode-test/barcode-test.keystore"
        RELEASE_SIGNING_PROPERTIES_URI: "https://s3.amazonaws.com/briebug-build/barcode-test/release-signing.properties"
        JSON_KEY_URI: "https://s3.amazonaws.com/briebug-build/key.json"
        DOWNLOAD_LOCATION: ${HOME}/${CIRCLE_PROJECT_REPONAME}/platforms/android/
        KEYSTORE_NAME: 'barcode-test.keystore'

    xcode:
        version: 8.0

## Customize dependencies
dependencies:
    pre:
        - bash ./get_keystore.sh
        - brew update
        - brew tap caskroom/cask
        - brew cleanup && brew cask cleanup
        - brew tap caskroom/versions
        - brew cask info java7
        - brew cask install java7
        - brew install android-sdk
        - echo y | android update sdk --no-ui --all --filter tools,platform-tools,extra-google-m2repository,extra-google-google_play_services,extra-android-support,android-24
        - echo y | android update sdk --no-ui --all --filter build-tools-24.0.0
        - npm install -g typescript ionic cordova@6.4.0 ios-deploy ios-sim
        - gem update fastlane

    post:
        - mkdir www
        - ionic prepare

## customize test commands
test:
    override:
        - echo 'No tests to run'
deployment:
    beta_distribution:
        branch: 'develop'
        commands:
            - cp build/* platforms/android
            - ionic build ios --release
            - ruby fastlane/select_xcode_signing_method.rb -p platforms/ios/barcode-test.xcodeproj -t barcode-test -m 'Manual' -b $CIRCLE_BUILD_NUM -i platforms/ios/barcode-test/barcode-test-Info.plist
            - fastlane ios beta
            - ionic build android --release -- --gradleArg=-PcdvVersionCode=$CIRCLE_BUILD_NUM
            - fastlane android beta
            - cp -R ./dist $CIRCLE_ARTIFACTS
